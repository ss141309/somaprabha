---
export interface Props {
  folder: string;
  width?: string;
  height?: string;
  viewBox?: string;
}

const { folder, width = "100%", height = "auto", viewBox: userViewBox } = Astro.props;

const id = Astro.props.id || folder.replace(/\//g, '-').replace(/[^a-z0-9-]/gi, '');

const allModules = import.meta.glob('/src/assets/images/**/*.svg', {
  eager: true,
  query: '?raw',
  import: 'default'
});

const matchingKeys = Object.keys(allModules).filter(path => {
  return path.replace(/\\/g, '/').includes(folder);
});

if (matchingKeys.length === 0) {
  throw new Error(`[AnimatedSVG] No frames found for "${folder}"`);
}

matchingKeys.sort((a, b) => {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
});

let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

const frames = matchingKeys.map(key => {
  const content = allModules[key] as string;
  const vbMatch = content.match(/viewBox=["']([^"']+)["']/i);

  if (vbMatch) {
    const [vx, vy, vw, vh] = vbMatch[1].split(/[\s,]+/).map(parseFloat);

    if (!isNaN(vx)) {
      if (vx < minX) minX = vx;
      if (vy < minY) minY = vy;
      // Max X is (x + width)
      if ((vx + vw) > maxX) maxX = vx + vw;
      // Max Y is (y + height)
      if ((vy + vh) > maxY) maxY = vy + vh;
    }
  }

  const match = content.match(/<svg[^>]*>([\s\S]*)<\/svg>/i);
  return match ? match[1].trim() : content.replace(/<\?xml[^>]*\?>/gi, '').trim();
});

let autoViewBox = '0 0 400 100';
if (minX !== Infinity) {
  const totalWidth = maxX - minX;
  const totalHeight = maxY - minY;
  const padX = totalWidth * 0.05;
  const padY = totalHeight * 0.05;
  autoViewBox = `${minX - padX} ${minY - padY} ${totalWidth + (padX*2)} ${totalHeight + (padY*2)}`;
}

const viewBox = userViewBox || autoViewBox;
---

<div class="animated-svg-container" data-animation-id={id}>
  <svg
    class="animated-svg"
    width={width}
    height={height}
    viewBox={viewBox}
    xmlns="http://www.w3.org/2000/svg"
  >
    <g class="frame-container" set:html={frames[0]} />
  </svg>

  <div class="controls">
    <button type="button" class="control-btn" data-action="prev" title="Previous frame">
      <svg width="20" height="20" viewBox="0 0 20 20"><path d="M15 3L7 10l8 7V3z" fill="currentColor"/><rect x="5" y="3" width="2" height="14" fill="currentColor"/></svg>
    </button>

    <button type="button" class="control-btn play-pause" data-action="play" title="Play/Pause">
      <svg class="play-icon" width="20" height="20" viewBox="0 0 20 20"><path d="M5 3l12 7-12 7V3z" fill="currentColor"/></svg>
      <svg class="pause-icon" width="20" height="20" viewBox="0 0 20 20" style="display: none;"><rect x="5" y="3" width="4" height="14" fill="currentColor"/><rect x="11" y="3" width="4" height="14" fill="currentColor"/></svg>
    </button>

    <button type="button" class="control-btn" data-action="next" title="Next frame">
      <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 3l8 7-8 7V3z" fill="currentColor"/><rect x="13" y="3" width="2" height="14" fill="currentColor"/></svg>
    </button>

    <button type="button" class="control-btn" data-action="reset" title="Reset">
      <svg width="20" height="20" viewBox="0 0 20 20">
        <path d="M10 3L2 10l8 7V3zm8 0L10 10l8 7V3z" fill="currentColor"/>
      </svg>
    </button>

    <span class="frame-indicator">
      <span class="current-frame">1</span> / <span class="total-frames">{frames.length}</span>
    </span>

    <label class="speed-control">
      <span>Speed:</span>
      <input type="range" min="0.5" max="3" value="1" step="0.5" class="speed-slider" />
      <span class="speed-value">1×</span>
    </label>
  </div>
</div>

<script define:vars={{ frames, id }}>
  console.log(`[Animation Init] Initializing animation for ID: "${id}" with ${frames.length} frames.`);

  class AnimationController {
      constructor(containerId, frames) {
          this.container = document.querySelector(`[data-animation-id="${containerId}"]`);

          if (!this.container) {
              console.error(`[Animation Error] Could not find container with data-animation-id="${containerId}"`);
              return;
          }

          this.frames = frames;
          this.currentFrame = 0;
          this.isPlaying = false;
          this.intervalId = null;
          this.baseSpeed = 800;
          this.speedMultiplier = 1;

          this.frameContainer = this.container.querySelector('.frame-container');
          this.playPauseBtn = this.container.querySelector('[data-action="play"]');
          this.currentFrameSpan = this.container.querySelector('.current-frame');
          this.speedSlider = this.container.querySelector('.speed-slider');
          this.speedValue = this.container.querySelector('.speed-value');

          this.init();
      }

      init() {
          const prevBtn = this.container.querySelector('[data-action="prev"]');
          const nextBtn = this.container.querySelector('[data-action="next"]');
          const resetBtn = this.container.querySelector('[data-action="reset"]');

          if(prevBtn) prevBtn.onclick = () => this.prevFrame();
          if(nextBtn) nextBtn.onclick = () => this.nextFrame();
          if(resetBtn) resetBtn.onclick = () => this.reset();

          if(this.playPauseBtn) {
              this.playPauseBtn.onclick = (e) => {
                  e.preventDefault();
                  this.togglePlay();
              };
          }

          if(this.speedSlider) {
              this.speedSlider.oninput = (e) => {
                  this.speedMultiplier = parseFloat(e.target.value);
                  this.speedValue.textContent = this.speedMultiplier + '×';
                  if (this.isPlaying) {
                      this.stop();
                      this.play();
                  }
              };
          }
      }

    showFrame(index) {
        if (index < 0 || index >= this.frames.length) return;
        this.currentFrame = index;

        if (!this.frames[index]) console.warn(`[Animation Warning] Frame ${index} seems empty.`);

        this.frameContainer.innerHTML = this.frames[index];
        this.currentFrameSpan.textContent = index + 1;
    }

    nextFrame() {
        const next = (this.currentFrame + 1) % this.frames.length;
        this.showFrame(next);
    }

    prevFrame() {
        const prev = (this.currentFrame - 1 + this.frames.length) % this.frames.length;
        this.showFrame(prev);
    }

      play() {
          this.isPlaying = true;
          const playIcon = this.playPauseBtn.querySelector('.play-icon');
          const pauseIcon = this.playPauseBtn.querySelector('.pause-icon');
          if(playIcon) playIcon.style.display = 'none';
          if(pauseIcon) pauseIcon.style.display = 'block';

          const actualSpeed = this.baseSpeed / this.speedMultiplier;
          this.intervalId = setInterval(() => this.nextFrame(), actualSpeed);
      }

      stop() {
          this.isPlaying = false;
          const playIcon = this.playPauseBtn.querySelector('.play-icon');
          const pauseIcon = this.playPauseBtn.querySelector('.pause-icon');
          if(playIcon) playIcon.style.display = 'block';
          if(pauseIcon) pauseIcon.style.display = 'none';

          if (this.intervalId) {
              clearInterval(this.intervalId);
              this.intervalId = null;
          }
      }

      togglePlay() {
          if (this.isPlaying) this.stop();
          else this.play();
      }

      reset() {
          this.stop();
          this.showFrame(0);
      }
  }

  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new AnimationController(id, frames));
  } else {
      new AnimationController(id, frames);
  }
</script>

<style>
  .animated-svg-container {
      margin: 2rem 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      width: 100%;
  }

  .animated-svg {
      border-radius: 0;
      background: #FFFFF0;
      display: block;
      max-width: 100%;
  }

  .controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #FFFFF0;
      border: 2px solid #000;
      border-radius: 0;
      box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
      min-height: 54px;
      box-sizing: border-box;
  }

  .control-btn {
      background: #FFFFF0;
      border: 2px solid #000;
      border-radius: 0;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      width: 36px;
      height: 36px;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      flex-shrink: 0;
  }

  .control-btn:hover {
      background: #f9f2d0;
  }

  .control-btn:active {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 rgba(0,0,0,0.1);
  }

  .frame-indicator {
      font-size: 0.95rem;
      color: #000;
      width: 80px;
      text-align: center;
      font-variant-numeric: tabular-nums;
  }

  .speed-control {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: #000;
      margin-left: 0.5rem;
      padding-left: 0.5rem;
      border-left: 1px solid #ddd;
  }

  .speed-slider {
      -webkit-appearance: none;
      width: 100px;
      height: 4px;
      background: transparent;
      cursor: pointer;
      margin: 0;
  }

  .speed-slider::-webkit-slider-runnable-track {
      width: 100%;
      height: 2px;
      background: #000;
      border: none;
  }
  .speed-slider::-moz-range-track {
      width: 100%;
      height: 2px;
      background: #000;
      border: none;
  }

  .speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 14px;
      width: 14px;
      background: #FFFFF0;
      border: 2px solid #000;
      border-radius: 0;
      margin-top: -6px;
      box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
      transition: transform 0.1s;
  }

  .speed-slider::-moz-range-thumb {
      height: 14px;
      width: 14px;
      background: #FFFFF0;
      border: 2px solid #000;
      border-radius: 0;
      box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
      transition: transform 0.1s;
  }

  .speed-slider:hover::-webkit-slider-thumb {
      transform: scale(1.1);
      background: #f9f2d0;
  }

  .speed-value {
      display: inline-block;
      width: 32px;
      text-align: right;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
  }

  @media (max-width: 600px) {
      .controls {
          flex-wrap: wrap;
          justify-content: center;
          gap: 1rem;
      }

    .speed-control {
        width: 100%;
        justify-content: center;
        border-left: none;
        padding-left: 0;
        border-top: 1px solid #ddd;
        padding-top: 0.75rem;
    }
  }
</style>
